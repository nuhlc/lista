<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro Digital de Presença</title>
  <!-- Biblioteca do leitor de QR (será cacheada pelo Service Worker) -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #1e88e5;
      --bg: #f9f9f9;
      --text: #333;
      --border: #ddd;
      --danger: #b00020;
      --success: #2e7d32;
      --muted: #9aa0a6;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding: 20px; margin: 0;
    }
    #container {
      max-width: 600px; margin: auto; background: #fff; border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); padding: 20px;
    }
    #logo { text-align: center; margin-bottom: 20px; }
    #logo img { max-width: 80%; height: auto; }
    /* TÍTULO em cinza escuro (pedido #2) */
    h2 { text-align: center; color: #333333; margin: 0 0 8px; }
    /* Barra de status online/offline em cinza claro */
    #statusBar {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 12px;
      min-height: 18px;
    }
    form { margin-top: 12px; }
    label { font-size: 13px; color: #555; }
    input, select, button {
      width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px;
      border: 1px solid var(--border); font-size: 14px;
      background: #fff;
    }
    input[readonly] {
      background: #f7f7f7;
      color: #555;
      cursor: not-allowed;
    }
    /* BOTÃO com novo texto (pedido #1) */
    button {
      background-color: #A40000; color: #fff; font-weight: 600;
      border: none; cursor: pointer; transition: background 0.2s ease;
      margin-top: 12px;
    }
    button:hover { background-color: #7a0000; }
    #reader { width: 100%; margin: 16px auto 0; }
    #msg { margin-top: 10px; font-weight: 600; color: var(--success); min-height: 20px; }
    #msg.error { color: var(--danger); }
    #lista-registros { margin-top: 30px; display: none; } /* Oculto (pedido #6) */
    table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
    th, td { border: 1px solid var(--border); padding: 8px; text-align: left; }
    th { background-color: #f1f1f1; }
    audio { display: none; }
    .hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="logo">
      <img src="imagem" alt="Logo do Evento" />
    </div>

    <h2>Registro Digital de Presença</h2>
    <div id="statusBar"></div>

    <div id="reader"></div>

    <form id="form" autocomplete="off">
      <!-- Nome e Código vêm da URL (readonly) -->
      <label for="nome">Nome Completo</label>
      <input type="text" id="nome" name="nome" placeholder="Nome" required readonly>

      <label for="codigo">Código (memberId)</label>
      <input type="text" id="codigo" name="codigo" placeholder="Código (memberId)" required readonly>

      <!-- Evento preenchido APENAS pelo QR do EVENTO -->
      <label for="evento">Evento (QR)</label>
      <input
        type="text"
        id="evento"
        name="evento"
        placeholder="Aproxime o QR do evento"
        required
        readonly
        inputmode="none"
      >
      <div class="hint">O evento só é preenchido ao ler o QR Code do evento.</div>

      <button type="submit">Enviar registro digital de presença</button>
    </form>

    <p id="msg"></p>

    <div id="lista-registros">
      <h3>Presenças Registradas</h3>
      <table>
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Nome</th>
            <th>Código</th>
            <th>Evento</th>
          </tr>
        </thead>
        <tbody id="tabela-registros">
          <!-- registros aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <audio id="bip" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    // ====== Constantes e elementos ======
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbwHk6o909wUncUcY0g0nRgJSpiZ-ZI7MtZjxMRCTrVU2yh9zm_M9uULA6SBYnTcuL0mEw/exec";

    const form = document.getElementById('form');
    const nomeInput = document.getElementById('nome');
    const codigoInput = document.getElementById('codigo');
    const eventoInput = document.getElementById('evento');
    const msg = document.getElementById('msg');
    const registrosTabela = document.getElementById('tabela-registros');
    const statusBar = document.getElementById('statusBar');
    const bip = document.getElementById('bip');

    // Flag que só fica true quando o QR do EVENTO for lido (pedido #3)
    let eventoValido = false;

    // ====== Prefill por URL: ?name=...&code=... ======
    (function prefillFromURL() {
      const params = new URLSearchParams(location.search);
      const nomeURL = params.get('name') || '';
      const codigoURL = params.get('code') || '';
      if (nomeURL)  nomeInput.value = decodeURIComponent(nomeURL);
      if (codigoURL) codigoInput.value = decodeURIComponent(codigoURL);
    })();

    // ====== Bloquear qualquer tentativa de digitar/colar no campo "evento" ======
    ['keydown','keypress','keyup','paste','drop','input','focus'].forEach(evt => {
      eventoInput.addEventListener(evt, e => {
        // Mantém readonly rígido
        if (evt !== 'focus') e.preventDefault();
        // Evita até focar para digitar
        if (evt === 'focus') eventoInput.blur();
        return false;
      }, true);
    });

    // ====== Status online/offline (pedido #5) ======
    function atualizaStatus() {
      if (navigator.onLine) {
        statusBar.textContent = ""; // online -> sem ruído visual
        tentarEnviarFila(); // ao voltar online, dispara o envio da fila
      } else {
        statusBar.textContent = "Sem conexão no momento — os registros serão enviados automaticamente quando a internet voltar.";
      }
    }
    window.addEventListener('online', atualizaStatus);
    window.addEventListener('offline', atualizaStatus);
    atualizaStatus();

    // ====== Leitura do QR (EVENTO) ======
    function onScanSuccess(decodedText, decodedResult) {
      try {
        const data = JSON.parse(decodedText);
        // Esperado: {"nome":"NOME_DO_EVENTO","codigo":"DIA_OU_COD_DO_EVENTO"}
        if (data && data.nome && data.codigo) {
          eventoInput.value = `${data.nome} - ${data.codigo}`;
          eventoValido = true;
          bip.play();
          mostrarMensagem("Evento lido com sucesso!", false);
        } else {
          mostrarMensagem("QR do evento inválido. Formato esperado: {\"nome\":\"...\",\"codigo\":\"...\"}", true);
        }
      } catch (e) {
        mostrarMensagem("Erro ao ler o QR do evento.", true);
      }
    }

    // Inicializa o leitor (cacheado via SW para funcionar offline depois de aberto ao menos uma vez)
    let html5QrcodeInstance;
    (function initScanner() {
      try {
        html5QrcodeInstance = new Html5Qrcode("reader");
        html5QrcodeInstance.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          onScanSuccess
        );
      } catch (err) {
        // Caso a câmera não esteja disponível (ex.: desktop sem permissão)
        console.warn("Falha ao iniciar o leitor de QR:", err);
      }
    })();

    // ====== Envio com fallback offline (pedido #4) ======
    // Guardar fila no localStorage para simplicidade/portabilidade
    function getFila() {
      try { return JSON.parse(localStorage.getItem('filaRegistros') || '[]'); }
      catch { return []; }
    }
    function setFila(arr) {
      localStorage.setItem('filaRegistros', JSON.stringify(arr));
    }
    async function enviarRegistro(record) {
      const formData = new URLSearchParams();
      formData.append("nome", record.nome);
      formData.append("codigo", record.codigo);
      formData.append("evento", record.evento);
      formData.append("horario", record.horario);

      const resp = await fetch(ENDPOINT, { method: "POST", body: formData });
      if (!resp.ok) throw new Error("Falha no envio");
      return true;
    }
    async function tentarEnviarFila() {
      let fila = getFila();
      if (!fila.length || !navigator.onLine) return;
      // Envia sequencialmente para simplificar e evitar sobrecarga
      const novaFila = [];
      for (const item of fila) {
        try {
          await enviarRegistro(item);
          // opcional: feedback silencioso
        } catch (e) {
          // Se falhar, mantém na fila
          novaFila.push(item);
        }
      }
      setFila(novaFila);
      if (fila.length && !novaFila.length) {
        mostrarMensagem("Registros pendentes enviados com sucesso.", false);
      }
    }

    form.addEventListener("submit", async function(e) {
      e.preventDefault();

      // Garante que o EVENTO veio do QR (pedido #3)
      if (!eventoValido || !eventoInput.value.trim()) {
        mostrarMensagem("Leia o QR do evento para prosseguir.", true);
        return;
      }

      const nome = nomeInput.value.trim();
      const codigo = codigoInput.value.trim();
      const evento = eventoInput.value.trim();
      const horario = new Date().toLocaleString("pt-BR");

      const registro = { nome, codigo, evento, horario };

      // Tenta enviar online; se falhar ou estiver offline, salva na fila
      if (navigator.onLine) {
        try {
          await enviarRegistro(registro);
          mostrarMensagem("Presença registrada com sucesso!", false);
          // (Lista de registros está oculta por solicitação #6; mantemos função para uso futuro)
          // exibirNaTabela(registro);
          bip.play();
        } catch (err) {
          // Falhou online -> joga para fila
          salvaOffline(registro);
          mostrarMensagem("Sem conexão estável. Registro salvo offline e será enviado automaticamente.", true);
        }
      } else {
        salvaOffline(registro);
        mostrarMensagem("Você está offline. Registro salvo e será enviado quando a internet voltar.", true);
      }

      // Limpa apenas o EVENTO para o próximo QR e reseta a flag
      eventoInput.value = "";
      eventoValido = false;
    });

    function salvaOffline(registro) {
      const fila = getFila();
      fila.push(registro);
      setFila(fila);
    }

    function exibirNaTabela({ nome, codigo, evento, horario }) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${horario}</td>
        <td>${nome}</td>
        <td>${codigo}</td>
        <td>${evento}</td>
      `;
      registrosTabela.prepend(tr);
    }

    function mostrarMensagem(texto, isErro) {
      msg.textContent = texto;
      msg.classList.toggle('error', !!isErro);
    }

    // ====== Service Worker para cache offline ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => {
          console.warn('SW não registrado:', err);
        });
      });
    }
  </script>
</body>
</html>
